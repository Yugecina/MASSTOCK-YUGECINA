name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build Frontend
        working-directory: frontend
        run: |
          echo "VITE_API_URL=https://api.dorian-gonzalez.fr/api/v1" > .env.production
          echo "VITE_ENV=production" >> .env.production
          echo "VITE_LOG_LEVEL=none" >> .env.production
          npm ci
          npm run build

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          DEPLOY_PATH: /opt/masstock
        run: |
          echo "ðŸš€ Deploying to production..."

          # Create deployment script
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e

          DEPLOY_PATH=$1
          BACKUP_DIR="${DEPLOY_PATH}/backups/$(date +%Y%m%d_%H%M%S)"

          echo "ðŸ“¦ Creating backup..."
          mkdir -p "$BACKUP_DIR"
          if [ -f "${DEPLOY_PATH}/backend/.env.production" ]; then
            cp "${DEPLOY_PATH}/backend/.env.production" "$BACKUP_DIR/"
          fi
          if [ -f "${DEPLOY_PATH}/docker-compose.production.yml" ]; then
            cp "${DEPLOY_PATH}/docker-compose.production.yml" "$BACKUP_DIR/"
          fi

          echo "ðŸ“¥ Pulling latest code..."
          cd "$DEPLOY_PATH"
          git fetch origin
          git reset --hard origin/main

          echo "ðŸ—ï¸  Building and restarting services..."
          docker-compose -f docker-compose.production.yml build
          docker-compose -f docker-compose.production.yml up -d

          echo "ðŸ§¹ Cleaning up old Docker images..."
          docker image prune -f

          echo "âœ… Deployment complete!"
          EOF

          # Make script executable and upload
          chmod +x deploy.sh
          scp deploy.sh $VPS_USER@$VPS_HOST:~/deploy.sh

          # Execute deployment on VPS
          ssh $VPS_USER@$VPS_HOST "bash ~/deploy.sh $DEPLOY_PATH"

      - name: Health Check
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "ðŸ¥ Running health checks..."

          # Wait for services to start
          sleep 30

          # Check API health
          ssh $VPS_USER@$VPS_HOST "curl -f https://api.dorian-gonzalez.fr/health || exit 1"

          # Check frontend
          ssh $VPS_USER@$VPS_HOST "curl -f https://dorian-gonzalez.fr || exit 1"

          # Check Docker services
          ssh $VPS_USER@$VPS_HOST "docker-compose -f /opt/masstock/docker-compose.production.yml ps | grep -E '(api|worker|redis)' | grep -v Exit || exit 1"

          echo "âœ… All health checks passed!"

      - name: Rollback on failure
        if: failure()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          DEPLOY_PATH: /opt/masstock
        run: |
          echo "âŒ Deployment failed! Rolling back..."

          ssh $VPS_USER@$VPS_HOST << EOF
            cd $DEPLOY_PATH
            LATEST_BACKUP=\$(ls -t backups/ | head -1)
            if [ -n "\$LATEST_BACKUP" ]; then
              echo "ðŸ“¦ Restoring from backup: \$LATEST_BACKUP"
              cp "backups/\$LATEST_BACKUP/.env.production" backend/.env.production
              docker-compose -f docker-compose.production.yml restart
              echo "âœ… Rollback complete"
            else
              echo "âš ï¸  No backup found, manual intervention required"
              exit 1
            fi
          EOF

      - name: Notify success
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "Frontend: https://dorian-gonzalez.fr"
          echo "Backend API: https://api.dorian-gonzalez.fr"

      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Check logs above for details."
