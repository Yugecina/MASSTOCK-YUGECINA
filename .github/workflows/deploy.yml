name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          DEPLOY_PATH: /opt/masstock
        run: |
          echo "ðŸš€ Deploying to production..."

          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e

            echo "ðŸ“¥ Pulling latest code..."
            cd /opt/masstock
            git fetch origin
            git reset --hard origin/main

            echo "ðŸ—ï¸  Building and restarting services..."
            ./deploy/build-and-start.sh --rebuild

            echo "âœ… Deployment complete!"
          ENDSSH

      - name: Health Check
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "ðŸ¥ Running health checks..."

          # Wait for services to start
          sleep 30

          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e

            echo "Checking API health..."
            curl -f http://api.dorian-gonzalez.fr/health || exit 1

            echo "Checking frontend..."
            curl -f http://dorian-gonzalez.fr/health || exit 1

            echo "Checking Docker containers..."
            docker ps | grep masstock_api || exit 1
            docker ps | grep masstock_worker || exit 1
            docker ps | grep masstock_redis || exit 1
            docker ps | grep masstock_nginx || exit 1

            echo "âœ… All health checks passed!"
          ENDSSH

      - name: Rollback on failure
        if: failure()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          echo "âŒ Deployment failed! Rolling back..."

          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            cd /opt/masstock
            ./deploy/rollback.sh
          ENDSSH

      - name: Notify success
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "Frontend: http://dorian-gonzalez.fr"
          echo "Backend API: http://api.dorian-gonzalez.fr"

      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Check logs above for details."
